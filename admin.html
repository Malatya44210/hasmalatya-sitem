<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli - Has Malatya Pazarı</title>
    <link rel="icon" type="image/jpeg" href="has-malatya-logo.jpg">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f6f8fa; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e67e22; padding-bottom: 10px; flex-wrap: wrap; gap: 1rem; }
        h1, h2 { color: #d35400; }
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px;}
        .product-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .product-card h3 { margin-top: 0; }
        .product-card .price { font-weight: bold; color: #27ae60; font-size: 1.2em; }
        .product-card .category { background-color: #f1f1f1; color: #555; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; display: inline-block; margin-top: auto; }
        .actions button { margin: 10px 10px 0 0; padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; }
        .edit-btn { background-color: #f39c12; color: white; }
        .delete-btn { background-color: #e74c3c; color: white; }
        .save-btn { background-color: #27ae60; color: white; font-size: 1.2em; padding: 15px 25px; border-radius: 8px; cursor: pointer; border: none; transition: background-color 0.3s; }
        .save-btn:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .form-section { background: #fff; padding: 20px; border-radius: 8px; margin-top: 30px; border: 1px solid #ddd; }
        .form-section input, .form-section textarea, .form-section select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-section button { background-color: #3498db; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .status-message { padding: 10px; border-radius: 5px; color: white; text-align: center; font-weight: bold; margin-top: 10px; display: none; }
        .status-success { background-color: #27ae60; }
        .status-error { background-color: #c0392b; }
        .category-item { display: inline-flex; align-items: center; gap: 5px; margin-right: 10px; background: #eee; padding: 5px 10px; border-radius: 5px; margin-bottom: 5px; }
        .delete-cat-btn { color: red; cursor: pointer; border: none; background: none; font-weight: bold; font-size: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ürün Yönetim Paneli</h1>
            <div>
                <div id="statusMessage" class="status-message"></div>
            </div>
        </div>
        <div class="form-section">
             <h2>Kategorileri Yönet</h2>
             <div id="category-list"></div>
             <div style="display: flex; gap: 10px; margin-top: 10px;">
                 <input type="text" id="newCategoryName" placeholder="Yeni Kategori Adı (Örn: Pekmezler)" style="flex: 1;">
                 <input type="text" id="newCategorySlug" placeholder="Kısa Ad (örn: pekmez)" style="flex: 1;">
                 <button onclick="addCategory()" style="flex-shrink: 0;">Ekle</button>
             </div>
             <button class="save-btn" id="saveCategoriesBtn" onclick="saveCategories()" style="margin-top: 10px; display: none;">Kategori Değişikliklerini Kaydet</button>
        </div>
        <div id="productFormContainer" class="form-section">
            <h2 id="form-title">Yeni Ürün Ekle</h2>
            <form id="productForm" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="productId">
                <label>Ürün Kategorisi</label>
                <select id="productCategory" required></select>
                <label>Ürün Başlığı</label>
                <input type="text" id="productTitle" required>
                <label>Açıklama</label>
                <textarea id="productDescription" rows="3" required></textarea>
                <label>Fiyat (Örn: 149.90)</label>
                <input type="number" step="0.01" id="productPrice" required>
                <label>Ürün Resmi (Yeni eklerken veya değiştirirken seçin)</label>
                <input type="file" id="productImageFile" accept="image/jpeg, image/png, image/webp">
                <small>Resmi değiştirmek istemiyorsanız bu alanı boş bırakabilirsiniz.</small>
                <input type="hidden" id="productImageUrl">
                <button type="submit" id="form-submit-btn">Ürünü Kaydet</button>
                <button type="button" onclick="cancelEdit()" id="cancel-edit-btn" style="display:none; background-color:#7f8c8d;">İptal</button>
            </form>
        </div>
        <h2 style="margin-top: 30px;">Mevcut Ürünler</h2>
        <div id="productList" class="product-list"></div>
    </div>

    <script>
        const GITHUB_USERNAME = "Malatya44210";
        const GITHUB_REPO = "hasmalatya-sitem";
        const FILE_PATH = "products.json";

        let products = []; let categories = []; let fileSha = null; let editingProductId = null;
        const statusMessage = document.getElementById('statusMessage');
        const saveCategoriesBtn = document.getElementById('saveCategoriesBtn');

        async function loadFileFromGithub() {
            const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${FILE_PATH}`;
            try {
                const response = await fetch(`${url}?v=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`GitHub'dan okunamadı: ${response.statusText}`);
                const data = await response.json();
                fileSha = data.sha;
                const fileContent = atob(data.content);
                const jsonData = JSON.parse(fileContent);
                products = jsonData.products || []; categories = jsonData.categories || [];
                renderAll();
            } catch (error) { showStatus(`Hata: ${error.message}. Ayarları kontrol edin.`, 'error'); }
        }
        
        async function handleFormSubmit(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('form-submit-btn');
            submitBtn.disabled = true; submitBtn.innerText = 'İşleniyor...';
            showStatus('Değişiklikler gönderiliyor...', 'progress');

            let productData = {
                id: editingProductId || 'product-' + Date.now(),
                title: document.getElementById('productTitle').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                imageUrl: document.getElementById('productImageUrl').value,
                category: document.getElementById('productCategory').value
            };

            const imageFile = document.getElementById('productImageFile').files[0];
            let imagePayload = null;
            if (imageFile) {
                const toBase64 = file => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
                imagePayload = { name: imageFile.name, content: await toBase64(imageFile) };
            }
            
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sha: fileSha,
                        categories: categories,
                        product: productData,
                        image: imagePayload
                    })
                });
                const responseData = await response.json();
                if (!response.ok) { throw new Error(responseData.error || `Sunucu hatası: ${response.statusText}`); }

                showStatus('Başarıyla kaydedildi! Sayfa yenileniyor...', 'success');
                setTimeout(() => location.reload(), 2000);

            } catch (error) {
                showStatus(`Hata: ${error.message}.`, 'error');
                submitBtn.disabled = false; submitBtn.innerText = 'Tekrar Dene';
            }
        }
        
        async function saveCategories() {
             saveCategoriesBtn.disabled = true; saveCategoriesBtn.innerText = 'Kaydediliyor...';
             // Bu fonksiyon sadece kategori değişikliğini kaydeder, ürün listesini mevcut haliyle gönderir.
             try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sha: fileSha,
                        categories: categories,
                        product: null, // Sadece kategorileri güncelliyoruz
                        image: null
                    })
                });
                 const responseData = await response.json();
                 if (!response.ok) { throw new Error(responseData.error || `Sunucu hatası: ${response.statusText}`); }
                 showStatus('Kategoriler başarıyla kaydedildi! Sayfa yenileniyor...', 'success');
                 setTimeout(() => location.reload(), 2000);
             } catch (error) {
                 showStatus(`Hata: ${error.message}.`, 'error');
                 saveCategoriesBtn.disabled = false; saveCategoriesBtn.innerText = 'Tekrar Dene';
             }
        }
        
        function renderAll() { renderCategories(); renderProducts(); updateCategoryDropdown(); }
        function renderCategories() { const list = document.getElementById('category-list'); list.innerHTML = ''; categories.forEach(cat => { list.innerHTML += `<div class="category-item"><span>${cat.name} (${cat.slug})</span><button class="delete-cat-btn" onclick="deleteCategory('${cat.slug}')">×</button></div>`; }); }
        function renderProducts() { const list = document.getElementById('productList'); list.innerHTML = ''; products.forEach(p => { const cat = categories.find(c => c.slug === p.category); list.innerHTML += `<div class="product-card"><h3>${p.title}</h3><p>${p.description}</p><div class="price">₺${parseFloat(p.price).toFixed(2)}</div><div class="actions"><button class="edit-btn" onclick="editProduct('${p.id}')">Düzenle</button><button class="delete-btn" onclick="deleteProduct('${p.id}')">Sil</button></div><span class="category">${cat ? cat.name : 'Kategorisiz'}</span></div>`; }); }
        function updateCategoryDropdown() { document.getElementById('productCategory').innerHTML = categories.map(cat => `<option value="${cat.slug}">${cat.name}</option>`).join(''); }
        function addCategory() { const nameInput = document.getElementById('newCategoryName'), slugInput = document.getElementById('newCategorySlug'); const name = nameInput.value.trim(); let slug = slugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-'); if (!slug) { slug = name.toLowerCase().replace(/[ıİ]/g, 'i').replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's').replace(/ö/g, 'o').replace(/ç/g, 'c').replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''); } if (name && slug && !categories.some(c => c.slug === slug)) { categories.push({ name, slug }); nameInput.value = ''; slugInput.value = ''; renderAll(); enableCategorySaving(); } else { alert("Geçerli ve benzersiz bir kategori adı/kısa ad girin."); } }
        function deleteCategory(slug) { if (products.some(p => p.category === slug)) { alert("Bu kategori kullanıldığı için silinemez."); return; } if (confirm(`'${slug}' kategorisini silmek istediğinizden emin misiniz?`)) { categories = categories.filter(c => c.slug !== slug); renderAll(); enableCategorySaving(); } }
        function editProduct(id) {
            const p = products.find(p => p.id === id); editingProductId = id;
            document.getElementById('productId').value = p.id;
            document.getElementById('productTitle').value = p.title;
            document.getElementById('productDescription').value = p.description;
            document.getElementById('productPrice').value = p.price;
            document.getElementById('productImageUrl').value = p.imageUrl;
            document.getElementById('productCategory').value = p.category;
            document.getElementById('form-title').innerText = "Ürünü Düzenle";
            document.getElementById('form-submit-btn').innerText = "Değişiklikleri Kaydet";
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            document.getElementById('productFormContainer').scrollIntoView({ behavior: 'smooth' });
        }
        function deleteProduct(id) {
            if (confirm('Bu ürünü silmek istediğinizden emin misiniz? Bu işlem SADECE bu panelden siler. Kalıcı olarak kaydetmek için ana kaydet butonuna basmanız gerekir.')) {
                 // Sadece ürün silmek için de ana kaydetme mekanizması kullanılacak.
                 // Bu nedenle şimdilik sadece listeden kaldırıp, kaydet butonunu aktif ediyoruz.
                 products = products.filter(p => p.id !== id);
                 renderAll();
                 // Ürün silme işlemini kaydetmek için özel bir fonksiyon yazılabilir veya saveCategories gibi genel bir kaydetme fonksiyonu tetiklenebilir. Şimdilik manuel kayda bırakalım.
                 alert("Ürün listeden kaldırıldı. Değişikliği kalıcı yapmak için lütfen ürün ekleme/düzenleme formundan boş bir kayıt gönderin veya bir kategoriyi kaydedin.");
            }
        }
        function resetForm() { document.getElementById('productForm').reset(); editingProductId = null; document.getElementById('form-title').innerText = "Yeni Ürün Ekle"; document.getElementById('form-submit-btn').innerText = "Ürünü Kaydet"; document.getElementById('cancel-edit-btn').style.display = 'none'; }
        function enableCategorySaving() { saveCategoriesBtn.style.display = 'block'; saveCategoriesBtn.disabled = false; }
        function showStatus(message, type) { statusMessage.textContent = message; statusMessage.className = `status-message status-${type}`; statusMessage.style.display = 'block'; if (type === 'success' || type === 'error') { setTimeout(() => { statusMessage.style.display = 'none'; }, 4000); } }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadFileFromGithub();
        });
    </script>
</body>
</html>